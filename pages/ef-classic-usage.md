<!--
GENERATED FILE - DO NOT EDIT
This file was generated by [MarkdownSnippets](https://github.com/SimonCropp/MarkdownSnippets).
Source File: /pages/mdsource/ef-classic-usage.source.md
To change this file edit the source file and then run MarkdownSnippets.
-->

# Classic EntityFramework Classic Usage

Interactions with SqlLocalDB via [Classic Entity Framework](https://docs.microsoft.com/en-us/ef/ef6/).


## EfClassicLocalDb package [![NuGet Status](https://img.shields.io/nuget/v/EfClassicLocalDb.svg)](https://www.nuget.org/packages/EfClassicLocalDb/)

https://nuget.org/packages/EfClassicLocalDb/


## Schema and data

The snippets use a DbContext of the following form:

<!-- snippet: EfClassicLocalDb.Tests/Snippets/TheDbContext.cs -->
<a id='snippet-EfClassicLocalDb.Tests/Snippets/TheDbContext.cs'></a>
```cs
using System.Data.Common;
using System.Data.Entity;

public class TheDbContext :
    DbContext
{
    public DbSet<TheEntity> TestEntities { get; set; } = null!;

    public TheDbContext(DbConnection connection) :
        base(connection, false)
    {
    }

    protected override void OnModelCreating(DbModelBuilder model)
    {
        model.Entity<TheEntity>();
    }
}
```
<sup><a href='/src/EfClassicLocalDb.Tests/Snippets/TheDbContext.cs#L1-L18' title='Snippet source file'>snippet source</a> | <a href='#snippet-EfClassicLocalDb.Tests/Snippets/TheDbContext.cs' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

<!-- snippet: EfClassicLocalDb.Tests/Snippets/TheEntity.cs -->
<a id='snippet-EfClassicLocalDb.Tests/Snippets/TheEntity.cs'></a>
```cs
public class TheEntity
{
    public int Id { get; set; }
    public string? Property { get; set; }
}
```
<sup><a href='/src/EfClassicLocalDb.Tests/Snippets/TheEntity.cs#L1-L5' title='Snippet source file'>snippet source</a> | <a href='#snippet-EfClassicLocalDb.Tests/Snippets/TheEntity.cs' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## Initialize SqlInstance

SqlInstance needs to be initialized once.

To ensure this happens only once there are several approaches that can be used:


### Static constructor

In the static constructor of a test.

If all tests that need to use the SqlInstance existing in the same test class, then the SqlInstance can be initialized in the static constructor of that test class.

<!-- snippet: EfClassicStaticConstructor -->
<a id='snippet-efclassicstaticconstructor'></a>
```cs
public class Tests
{
    static SqlInstance<TheDbContext> sqlInstance;

    static Tests()
    {
        sqlInstance = new(
            connection => new(connection));
    }

    public async Task Test()
    {
        TheEntity entity = new()
        {
            Property = "prop"
        };
        List<object> data = new(){entity};
        using var database = await sqlInstance.Build(data);
        Assert.Single(database.Context.TestEntities);
    }
}
```
<sup><a href='/src/EfClassicLocalDb.Tests/Snippets/StaticConstructor.cs#L9-L31' title='Snippet source file'>snippet source</a> | <a href='#snippet-efclassicstaticconstructor' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


### Static constructor in test base

If multiple tests need to use the SqlInstance, then the SqlInstance should be initialized in the static constructor of test base class.

<!-- snippet: EfClassicTestBase -->
<a id='snippet-efclassictestbase'></a>
```cs
public abstract class TestBase
{
    static SqlInstance<TheDbContext> sqlInstance;

    static TestBase()
    {
        sqlInstance = new(
            constructInstance: connection => new(connection));
    }

    public Task<SqlDatabase<TheDbContext>> LocalDb(
        [CallerFilePath] string testFile = "",
        string? databaseSuffix = null,
        [CallerMemberName] string memberName = "")
    {
        return sqlInstance.Build(testFile, databaseSuffix, memberName);
    }
}

public class Tests :
    TestBase
{
    [Fact]
    public async Task Test()
    {
        using var database = await LocalDb();
        TheEntity entity = new()
        {
            Property = "prop"
        };
        await database.AddData(entity);

        Assert.Single(database.Context.TestEntities);
    }
}
```
<sup><a href='/src/EfClassicLocalDb.Tests/Snippets/EfClassicTestBaseUsage.cs#L8-L46' title='Snippet source file'>snippet source</a> | <a href='#snippet-efclassictestbase' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


### Seeding data in the template

Data can be seeded into the template database for use across all tests:

<!-- snippet: EfClassicBuildTemplate -->
<a id='snippet-efclassicbuildtemplate'></a>
```cs
public class BuildTemplate
{
    static SqlInstance<TheDbContext> sqlInstance;

    static BuildTemplate()
    {
        sqlInstance = new(
            constructInstance: connection => new(connection),
            buildTemplate: async context =>
            {
                await context.CreateOnExistingDb();
                TheEntity entity = new()
                {
                    Property = "prop"
                };
                context.TestEntities.Add(entity);
                await context.SaveChangesAsync();
            });
    }

    [Fact]
    public async Task Test()
    {
        using var database = await sqlInstance.Build();

        Assert.Single(database.Context.TestEntities);
    }
}
```
<sup><a href='/src/EfClassicLocalDb.Tests/Snippets/BuildTemplate.cs#L5-L36' title='Snippet source file'>snippet source</a> | <a href='#snippet-efclassicbuildtemplate' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## Usage in a Test

Usage inside a test consists of two parts:


### Build a SqlDatabase

<!-- snippet: EfClassicBuildDatabase -->
<a id='snippet-efclassicbuilddatabase'></a>
```cs
using var database = await sqlInstance.Build();
```
<sup><a href='/src/EfClassicLocalDb.Tests/Snippets/EfSnippetTests.cs#L19-L21' title='Snippet source file'>snippet source</a> | <a href='#snippet-efclassicbuilddatabase' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

See: [Database Name Resolution](/pages/directory-and-name-resolution.md#database-name-resolution)


### Using DbContexts

<!-- snippet: EfClassicBuildContext -->
<a id='snippet-efclassicbuildcontext'></a>
```cs
using (var data = database.NewDbContext())
{
```
<sup><a href='/src/EfClassicLocalDb.Tests/Snippets/EfSnippetTests.cs#L22-L25' title='Snippet source file'>snippet source</a> | <a href='#snippet-efclassicbuildcontext' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


#### Full Test

The above are combined in a full test:

<!-- snippet: EfClassicLocalDb.Tests/Snippets/EfSnippetTests.cs -->
<a id='snippet-EfClassicLocalDb.Tests/Snippets/EfSnippetTests.cs'></a>
```cs
#if(!NETCOREAPP3_1)
using System.Threading.Tasks;
using EfLocalDb;
using Xunit;

public class EfSnippetTests
{
    static SqlInstance<MyDbContext> sqlInstance;

    static EfSnippetTests()
    {
        sqlInstance = new(
            connection => new(connection));
    }

    [Fact]
    public async Task TheTest()
    {
        using var database = await sqlInstance.Build();
        using (var data = database.NewDbContext())
        {
            TheEntity entity = new()
            {
                Property = "prop"
            };
            data.TestEntities.Add(entity);
            await data.SaveChangesAsync();
        }

        using (var data = database.NewDbContext())
        {
            Assert.Single(data.TestEntities);
        }
    }

    [Fact]
    public async Task TheTestWithDbName()
    {
        using var database = await sqlInstance.Build("TheTestWithDbName");
        TheEntity entity = new()
        {
            Property = "prop"
        };
        await database.AddData(entity);

        Assert.Single(database.Context.TestEntities);
    }
}
#endif
```
<sup><a href='/src/EfClassicLocalDb.Tests/Snippets/EfSnippetTests.cs#L1-L49' title='Snippet source file'>snippet source</a> | <a href='#snippet-EfClassicLocalDb.Tests/Snippets/EfSnippetTests.cs' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## Using a pre-constructed template

It is possible to pass the path to a pre-existing template to SqlInstance. This is useful if the database contains stored procedures, or requires a large amount of test data.

<!-- snippet: EfClassicLocalDb.Tests/Snippets/SuppliedTemplate.cs -->
<a id='snippet-EfClassicLocalDb.Tests/Snippets/SuppliedTemplate.cs'></a>
```cs
using EfLocalDb;

static class SuppliedTemplate
{
    static SqlInstance<MyDbContext> sqlInstance;

    static SuppliedTemplate()
    {
        sqlInstance = new(
            connection => new(connection),
            existingTemplate: new("template.mdf", "template_log.ldf"));
    }
}
```
<sup><a href='/src/EfClassicLocalDb.Tests/Snippets/SuppliedTemplate.cs#L1-L13' title='Snippet source file'>snippet source</a> | <a href='#snippet-EfClassicLocalDb.Tests/Snippets/SuppliedTemplate.cs' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->
