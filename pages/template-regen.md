<!--
GENERATED FILE - DO NOT EDIT
This file was generated by [MarkdownSnippets](https://github.com/SimonCropp/MarkdownSnippets).
Source File: /pages/mdsource/template-regen.source.md
To change this file edit the source file and then run MarkdownSnippets.
-->

# Template Regen

Template re-generating performs the following action

 * Delete the existing template files.
 * Create a new template database.
 * Apply the default schema and data as defined by the `buildTemplate` parameter in the `SqlInstance` constructor.
 * Detach the database

Re-generating the template database is a relatively expensive operation. Ideally, it should only be performed when the default schema and data requires a change. To enable this a timestamp convention is used. When the template is re-generating, its file creation time is set to a timestamp. On the next run, that timestamp is compared to avoid re-generation on a match. The timestamp can be controlled via `timestamp` parameter in the `SqlInstance` constructor.

If `timestamp` parameter is not defined the following conventions are used:

 * For Raw SQL the last modified time of the calling Assembly using [Assembly.GetCallingAssembly](https://docs.microsoft.com/en-us/dotnet/api/system.reflection.assembly.getcallingassembly). This will usually result in the last modified time of the unit test assembly, and hence avoid re-generation unless a solution build has occurred.
 * For EntityFramework the last modified time of the Assembly containing the DataContext.

There is a timestamp helper class to help derive last modified time of an Assembly (if the above conventions do not suffice):

<!-- snippet: Timestamp -->
<a id='snippet-timestamp'></a>
```cs
public static class Timestamp
{
    public static DateTime LastModified(Delegate @delegate)
    {
        if (@delegate.Target != null)
        {
            var targetAssembly = @delegate.Target.GetType().Assembly;
            return LastModified(targetAssembly);
        }
        var declaringAssembly = @delegate.Method.DeclaringType!.Assembly;
        return LastModified(declaringAssembly);
    }

    public static DateTime LastModified(Assembly assembly)
    {
        return File.GetLastWriteTime(assembly.Location);
    }

    public static DateTime LastModified<T>()
    {
        return File.GetLastWriteTime(typeof(T).Assembly.Location);
    }
}
```
<sup><a href='/src/LocalDb/Timestamp.cs#L11-L35' title='Snippet source file'>snippet source</a> | <a href='#snippet-timestamp' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->
