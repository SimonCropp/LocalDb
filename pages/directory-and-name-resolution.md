<!--
GENERATED FILE - DO NOT EDIT
This file was generated by [MarkdownSnippets](https://github.com/SimonCropp/MarkdownSnippets).
Source File: /pages/mdsource/directory-and-name-resolution.source.md
To change this file edit the source file and then run MarkdownSnippets.
-->

# SqlLocalDB Directory and Instance Name Resolution

The instance name is defined as:

<!-- snippet: GetInstanceName -->
<a id='snippet-GetInstanceName'></a>
```cs
if (scopeSuffix is null)
{
    return typeof(TDbContext).Name;
}

return $"{typeof(TDbContext).Name}_{scopeSuffix}";
```
<sup><a href='/src/EfLocalDb/Storage.cs#L28-L37' title='Snippet source file'>snippet source</a> | <a href='#snippet-GetInstanceName' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

That InstanceName is then used to derive the data directory. In order:

 * If `LocalDBData` environment variable exists then use `LocalDBData\InstanceName`.
 * Use `%Temp%\LocalDb\InstanceName`.

Database files older than a day will be purged from the data directory.

There is an explicit registration override that takes an instance name and a directory for that instance:


## For SQL:

<!-- snippet: ExplicitName -->
<a id='snippet-ExplicitName'></a>
```cs
var sqlInstance = new SqlInstance(
    name: "theInstanceName",
    buildTemplate: TestDbBuilder.CreateTable,
    directory: @"C:\LocalDb\theInstance");
```
<sup><a href='/src/LocalDb.Tests/Snippets/ExplicitName.cs#L8-L15' title='Snippet source file'>snippet source</a> | <a href='#snippet-ExplicitName' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## For EntityFramework:

<!-- snippet: EfExplicitName -->
<a id='snippet-EfExplicitName'></a>
```cs
var sqlInstance = new SqlInstance<TheDbContext>(
    constructInstance: builder => new(builder.Options),
    storage: new("theInstanceName", @"C:\LocalDb\theInstance"));
```
<sup><a href='/src/EfLocalDb.Tests/Snippets/EfExplicitName.cs#L15-L21' title='Snippet source file'>snippet source</a> | <a href='#snippet-EfExplicitName' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## Building using Azure machines

When using azure hosted machines for build agents, it makes sense to use the agent temp directory as defined by the `AGENT_TEMPDIRECTORY` environment variable. The reason for this is that the temp directory is located on a secondary drive. However this drive has some strange permissions that will cause run time errors, usually manifesting as a SqlException with `Could not open new database...`. To work around this run the following script at machine startup:

<!-- snippet: Set-D-Drive-Permissions.ps1 -->
<a id='snippet-Set-D-Drive-Permissions.ps1'></a>
```ps1
$paths = @('D:\Agent', 'D:\Agent\Work', 'D:\Agent\Work\_Temp')

$paths | % {
    $d = [System.IO.Directory]::CreateDirectory($_)
    $acl = Get-Acl $d.FullName
    $ar = new-object System.Security.AccessControl.FileSystemAccessRule("Everyone", "FullControl", "ContainerInherit, ObjectInherit", "None", "Allow")
    $acl.AddAccessRule($ar)
    Set-Acl $d.FullName -AclObject $acl
}
```
<sup><a href='/src/StartUpScript/Set-D-Drive-Permissions.ps1#L1-L9' title='Snippet source file'>snippet source</a> | <a href='#snippet-Set-D-Drive-Permissions.ps1' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


# Database Name Resolution

A design goal is to have an isolated database per test. To facilitate this the `SqlInstance.Build` method has a convention based approach. It contains the following parameters:

 * `testFile`: defaults to the full path of the source file that contains the caller via [CallerFilePathAttribute](https://docs.microsoft.com/en-us/dotnet/api/system.runtime.compilerservices.callerfilepathattribute).
 * `memberName`: defaults to the method name of the caller to the method via [CallerMemberName](https://docs.microsoft.com/en-us/dotnet/api/system.runtime.compilerservices.callermembername).
 * `databaseSuffix`: an optional parameter to further uniquely a database name when the `testFile` and `memberName` are not sufficient. For example when using parameterized tests.

The convention signature is as follows:

<!-- snippet: ConventionBuildSignature -->
<a id='snippet-ConventionBuildSignature'></a>
```cs
/// <summary>
///     Build database with a name based on the calling Method.
/// </summary>
/// <param name="testFile">
///     The path to the test class.
///     Used to make the database name unique per test type.
/// </param>
/// <param name="databaseSuffix">
///     For Xunit theories add some text based on the inline data
///     to make the db name unique.
/// </param>
/// <param name="memberName">
///     Used to make the db name unique per method.
///     Will default to the caller method name is used.
/// </param>
/// <param name="cancel">The cancellation instruction.</param>
public Task<SqlDatabase> Build(
        [CallerFilePath] string testFile = "",
        string? databaseSuffix = null,
        [CallerMemberName] string memberName = "",
        Cancel cancel = default)
```
<sup><a href='/src/LocalDb/SqlInstance.cs#L75-L99' title='Snippet source file'>snippet source</a> | <a href='#snippet-ConventionBuildSignature' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

With these parameters the database name is the derived as follows:

<!-- snippet: DeriveName -->
<a id='snippet-DeriveName'></a>
```cs
public static string DeriveDbName(
    string? suffix,
    string member,
    string testClass)
{
    if (suffix is null)
    {
        return $"{testClass}_{member}";
    }

    return $"{testClass}_{member}_{suffix}";
}
```
<sup><a href='/src/LocalDb/DbNamer.cs#L3-L18' title='Snippet source file'>snippet source</a> | <a href='#snippet-DeriveName' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## Explicit name

If full control over the database name is required, there is an overload that takes an explicit name:

<!-- snippet: ExplicitBuildSignature -->
<a id='snippet-ExplicitBuildSignature'></a>
```cs
/// <summary>
///     Build database with an explicit name.
/// </summary>
public async Task<SqlDatabase> Build(string dbName, Cancel cancel = default)
```
<sup><a href='/src/LocalDb/SqlInstance.cs#L114-L121' title='Snippet source file'>snippet source</a> | <a href='#snippet-ExplicitBuildSignature' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

Which can be used as follows:


### For SQL:

<!-- snippet: WithDbName -->
<a id='snippet-WithDbName'></a>
```cs
await using var database = await sqlInstance.Build(dbName: "TheTestWithDbName");
```
<sup><a href='/src/LocalDb.Tests/Snippets/SnippetTests.cs#L34-L38' title='Snippet source file'>snippet source</a> | <a href='#snippet-WithDbName' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


### For EntityFramework:

<!-- snippet: EfWithDbName -->
<a id='snippet-EfWithDbName'></a>
```cs
await using var database = await sqlInstance.Build(dbName: "TheTestWithDbName");
```
<sup><a href='/src/EfLocalDb.Tests/Snippets/EfSnippetTests.cs#L55-L59' title='Snippet source file'>snippet source</a> | <a href='#snippet-EfWithDbName' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->
