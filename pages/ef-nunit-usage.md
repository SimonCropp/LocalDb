<!--
GENERATED FILE - DO NOT EDIT
This file was generated by [MarkdownSnippets](https://github.com/SimonCropp/MarkdownSnippets).
Source File: /pages/mdsource/ef-nunit-usage.source.md
To change this file edit the source file and then run MarkdownSnippets.
-->

# EntityFramework Core NUnit Usage

Combines [EfLocalDb](/pages/ef-usage.md), [NUnit](https://nunit.org/), [Verify.NUnit](https://github.com/VerifyTests/Verify#verifynunit), and [Verify.EntityFramework](https://github.com/VerifyTests/Verify.EntityFramework) into a test base class that provides an isolated database per test with [Arrange-Act-Assert](https://learn.microsoft.com/en-us/visualstudio/test/unit-test-basics#write-your-tests) phase enforcement.


## EfLocalDb.NUnit package [![NuGet Status](https://img.shields.io/nuget/v/EfLocalDb.NUnit.svg)](https://www.nuget.org/packages/EfLocalDb.NUnit/)

https://nuget.org/packages/EfLocalDb.NUnit/


## Schema and data

The snippets use a DbContext of the following form:

<!-- snippet: EfLocalDb.NUnit.Tests/Model/TheDbContext.cs -->
<a id='snippet-EfLocalDb.NUnit.Tests/Model/TheDbContext.cs'></a>
```cs
public class TheDbContext(DbContextOptions options) :
    DbContext(options)
{
    public DbSet<Company> Companies { get; set; } = null!;
    public DbSet<Employee> Employees { get; set; } = null!;

    protected override void OnModelCreating(ModelBuilder builder)
    {
        var company = builder.Entity<Company>();
        company.HasKey(_ => _.Id);
        company
            .HasMany(_ => _.Employees)
            .WithOne(_ => _.Company)
            .IsRequired();

        var employee = builder.Entity<Employee>();
        employee.HasKey(_ => _.Id);
        employee
            .HasMany(_ => _.Vehicles)
            .WithOne(_ => _.Employee)
            .IsRequired();

        var vehicle = builder.Entity<Vehicle>();
        vehicle.HasKey(_ => _.Id);
    }
}
```
<sup><a href='/src/EfLocalDb.NUnit.Tests/Model/TheDbContext.cs#L1-L26' title='Snippet source file'>snippet source</a> | <a href='#snippet-EfLocalDb.NUnit.Tests/Model/TheDbContext.cs' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

<!-- snippet: EfLocalDb.NUnit.Tests/Model/Company.cs -->
<a id='snippet-EfLocalDb.NUnit.Tests/Model/Company.cs'></a>
```cs
public class Company
{
    public required Guid Id { get; init; }
    public required string Name { get; set; }
    public List<Employee> Employees { get; set; } = [];
}
```
<sup><a href='/src/EfLocalDb.NUnit.Tests/Model/Company.cs#L1-L6' title='Snippet source file'>snippet source</a> | <a href='#snippet-EfLocalDb.NUnit.Tests/Model/Company.cs' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

<!-- snippet: EfLocalDb.NUnit.Tests/Model/Employee.cs -->
<a id='snippet-EfLocalDb.NUnit.Tests/Model/Employee.cs'></a>
```cs
public class Employee
{
    public required Guid CompanyId { get; set; }
    public Company? Company { get; init; }
    public required Guid Id { get; init; }
    public required string Name { get; set; }
    public List<Vehicle> Vehicles { get; set; } = [];
}
```
<sup><a href='/src/EfLocalDb.NUnit.Tests/Model/Employee.cs#L1-L8' title='Snippet source file'>snippet source</a> | <a href='#snippet-EfLocalDb.NUnit.Tests/Model/Employee.cs' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## Initialize

`LocalDbTestBase<T>.Initialize` needs to be called once. This is best done in a [ModuleInitializer](https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/proposals/csharp-9.0/module-initializers):

<!-- snippet: EfLocalDb.NUnit.Tests/ModuleInitializer.cs -->
<a id='snippet-EfLocalDb.NUnit.Tests/ModuleInitializer.cs'></a>
```cs
public static class ModuleInitializer
{
    [ModuleInitializer]
    public static void Initialize()
    {
        VerifyDiffPlex.Initialize(OutputType.Compact);
        VerifierSettings.InitializePlugins();
        LocalDbLogging.EnableVerbose();
        LocalDbSettings.ConnectionBuilder(_ => _.ConnectTimeout = 300);
        LocalDbTestBase<TheDbContext>.Initialize();
    }
}
```
<sup><a href='/src/EfLocalDb.NUnit.Tests/ModuleInitializer.cs#L1-L12' title='Snippet source file'>snippet source</a> | <a href='#snippet-EfLocalDb.NUnit.Tests/ModuleInitializer.cs' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## Usage in a Test

Inherit from `LocalDbTestBase<T>` and use the `ArrangeData`, `ActData`, and `AssertData` properties. These enforce phase ordering: accessing `ActData` transitions from Arrange to Act, and accessing `AssertData` transitions to Assert. Accessing a phase out of order throws an exception.

<!-- snippet: EfLocalDb.NUnit.Tests/Tests.cs -->
<a id='snippet-EfLocalDb.NUnit.Tests/Tests.cs'></a>
```cs
[TestFixture]
public class Tests :
    LocalDbTestBase<TheDbContext>
{
    [Test]
    public async Task Simple()
    {
        ArrangeData.Companies.Add(
            new()
            {
                Id = Guid.NewGuid(),
                Name = "value"
            });
        await ArrangeData.SaveChangesAsync();

        var entity = await ActData.Companies.SingleAsync();
        entity.Name = "value2";
        await ActData.SaveChangesAsync();

        var result = await AssertData.Companies.SingleAsync();
        await Verify(result);
    }

    [Test]
    public async Task StaticInstance()
    {
        Instance.ArrangeData.Companies.Add(
            new()
            {
                Id = Guid.NewGuid(),
                Name = "value"
            });
        await Instance.ArrangeData.SaveChangesAsync();

        var entity = await Instance.ActData.Companies.SingleAsync();
        entity.Name = "value2";
        await Instance.ActData.SaveChangesAsync();

        var result = await Instance.AssertData.Companies.SingleAsync();
        await Verify(result);
    }

    [Test]
    public Task Combinations()
    {
        string[] inputs = ["value1", "value2"];
        return Combination()
            .Verify(Run, inputs);

        async Task<Company> Run(string input)
        {
            ArrangeData.Companies.Add(
                new()
                {
                    Id = Guid.NewGuid(),
                    Name = "value"
                });
            await ArrangeData.SaveChangesAsync();

            var entity = await ActData.Companies.SingleAsync();
            entity.Name = input;
            await ActData.SaveChangesAsync();

            return await AssertData.Companies.SingleAsync();
        }
    }

    [Test]
    public Task Name() =>
        Verify(new
        {
            Database.Name,
            Database.Connection.DataSource
        });

    [Test]
    [TestCase("case")]
    public Task NameWithParams(string caseName) =>
        Verify(new
        {
            Database.Name,
            Database.Connection.DataSource
        });

    [Test]
    public Task ThrowForRedundantIgnoreQueryFilters() =>
        ThrowsTask(
                () =>
                {
                    var entities = AssertData.Companies;
                    return entities.IgnoreQueryFilters().SingleAsync();
                })
            .IgnoreStackTrace();

    [Test]
    public async Task IgnoreQueryFiltersAllowedOnArrangeAndAct()
    {
        await ArrangeData.Companies.IgnoreQueryFilters().ToListAsync();
        await ActData.Companies.IgnoreQueryFilters().ToListAsync();
    }

    [Test]
    public async Task ActInAsync()
    {
        ArrangeData.Companies.Add(
            new()
            {
                Id = Guid.NewGuid(),
                Name = "value"
            });
        await ArrangeData.SaveChangesAsync();

        await AsyncMethod();

        var result = await AssertData.Companies.SingleAsync();
        await Verify(result);

        async Task AsyncMethod()
        {
            await Task.Delay(1);
            var entity = await ActData.Companies.SingleAsync();
            entity.Name = "value2";
            await ActData.SaveChangesAsync();
        }
    }

    [Test]
    public async Task VerifyEntity()
    {
        var company = new Company
        {
            Id = Guid.NewGuid(),
            Name = "value"
        };
        ArrangeData.Companies.Add(company);
        await ArrangeData.SaveChangesAsync();
        await VerifyEntity<Company>(company.Id);
    }

    [Test]
    public async Task VerifyEntityNull() =>
        await VerifyEntity<Company>(Guid.NewGuid());

    [Test]
    public async Task VerifyEntityWithInclude()
    {
        var company = new Company
        {
            Id = Guid.NewGuid(),
            Name = "the Company"
        };
        var employee = new Employee
        {
            Id = Guid.NewGuid(),
            CompanyId = company.Id,
            Name = "the Employee"
        };
        ArrangeData.AddRange(company, employee);
        await ArrangeData.SaveChangesAsync();
        await VerifyEntity<Company>(company.Id)
            .Include(_ => _.Employees);
    }

    [Test]
    public async Task VerifyEntityWithThenInclude()
    {
        var company = new Company
        {
            Id = Guid.NewGuid(),
            Name = "the Company"
        };
        var employee = new Employee
        {
            Id = Guid.NewGuid(),
            CompanyId = company.Id,
            Name = "the Employee"
        };
        var vehicle = new Vehicle
        {
            Id = Guid.NewGuid(),
            EmployeeId = employee.Id,
            Model = "the Vehicle"
        };
        ArrangeData.AddRange(company, employee, vehicle);
        await ArrangeData.SaveChangesAsync();
        await VerifyEntity<Company>(company.Id)
            .Include(_ => _.Employees)
            .ThenInclude(_ => _.Vehicles);
    }

    [Test]
    public async Task VerifyEntities_DbSet()
    {
        ArrangeData.Companies.Add(
            new()
            {
                Id = Guid.NewGuid(),
                Name = "value"
            });
        await ArrangeData.SaveChangesAsync();
        await VerifyEntities(AssertData.Companies);
    }

    [Test]
    public async Task VerifyEntities_Queryable()
    {
        var company = new Company
        {
            Id = Guid.NewGuid(),
            Name = "value"
        };
        ArrangeData.Companies.Add(company);
        await ArrangeData.SaveChangesAsync();
        await VerifyEntities(AssertData.Companies.Where(_ => _.Id == company.Id));
    }

    [Test]
    public async Task VerifyEntity_Queryable()
    {
        var company = new Company
        {
            Id = Guid.NewGuid(),
            Name = "value"
        };
        ArrangeData.Companies.Add(company);
        await ArrangeData.SaveChangesAsync();
        await VerifyEntity(AssertData.Companies.Where(_ => _.Id == company.Id));
    }

    [Test]
    public async Task ArrangeQueryableAfterAct()
    {
        var company = new Company
        {
            Id = Guid.NewGuid(),
            Name = "value"
        };
        ArrangeData.Companies.Add(company);
        await ArrangeData.SaveChangesAsync();
        var queryable = ArrangeData.Companies.Where(_ => _.Id == company.Id);
        // ReSharper disable once UnusedVariable
        var act = ActData;
        await ThrowsTask(() => VerifyEntities(queryable))
            .IgnoreStackTrace()
            .DisableRequireUniquePrefix();
    }

    [Test]
    public Task AccessActAfterAssert()
    {
        // ReSharper disable once UnusedVariable
        var assert = AssertData;
        return Throws(() => ActData)
            .IgnoreStackTrace();
    }

    [Test]
    public async Task ActQueryableAfterAssert()
    {
        var company = new Company
        {
            Id = Guid.NewGuid(),
            Name = "value"
        };
        ArrangeData.Companies.Add(company);
        await ArrangeData.SaveChangesAsync();
        var queryable = ActData.Companies.Where(_ => _.Id == company.Id);
        // ReSharper disable once UnusedVariable
        var assert = AssertData;
        await ThrowsTask(() => VerifyEntities(queryable))
            .IgnoreStackTrace()
            .DisableRequireUniquePrefix();
    }

    [Test]
    public async Task ArrangeQueryableAfterAssert()
    {
        var company = new Company
        {
            Id = Guid.NewGuid(),
            Name = "value"
        };
        ArrangeData.Companies.Add(company);
        await ArrangeData.SaveChangesAsync();
        var queryable = ArrangeData.Companies.Where(_ => _.Id == company.Id);
        // ReSharper disable once UnusedVariable
        var assert = AssertData;
        await ThrowsTask(() => VerifyEntities(queryable))
            .IgnoreStackTrace()
            .DisableRequireUniquePrefix();
    }

    [Test]
    public Task AccessArrangeAfterAssert()
    {
        // ReSharper disable once UnusedVariable
        var assert = AssertData;
        return Throws(() => ArrangeData)
            .IgnoreStackTrace();
    }

    [Test]
    public Task AccessArrangeAfterAct()
    {
        // ReSharper disable once UnusedVariable
        var act = ActData;
        return Throws(() => ArrangeData)
            .IgnoreStackTrace();
    }
}
```
<sup><a href='/src/EfLocalDb.NUnit.Tests/Tests.cs#L1-L310' title='Snippet source file'>snippet source</a> | <a href='#snippet-EfLocalDb.NUnit.Tests/Tests.cs' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## Static Instance

The current test instance can be accessed via `LocalDbTestBase<T>.Instance`. This is useful when test helpers need to access the database outside the test class:

<!-- snippet: StaticInstance -->
<a id='snippet-StaticInstance'></a>
```cs
[Test]
public async Task StaticInstance()
{
    Instance.ArrangeData.Companies.Add(
        new()
        {
            Id = Guid.NewGuid(),
            Name = "value"
        });
    await Instance.ArrangeData.SaveChangesAsync();

    var entity = await Instance.ActData.Companies.SingleAsync();
    entity.Name = "value2";
    await Instance.ActData.SaveChangesAsync();

    var result = await Instance.AssertData.Companies.SingleAsync();
    await Verify(result);
}
```
<sup><a href='/src/EfLocalDb.NUnit.Tests/Tests.cs#L24-L43' title='Snippet source file'>snippet source</a> | <a href='#snippet-StaticInstance' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## Combinations

[Verify Combinations](https://github.com/VerifyTests/Verify#combinations) are supported. The database is reset for each combination:

<!-- snippet: Combinations -->
<a id='snippet-Combinations'></a>
```cs
[Test]
public Task Combinations()
{
    string[] inputs = ["value1", "value2"];
    return Combination()
        .Verify(Run, inputs);

    async Task<Company> Run(string input)
    {
        ArrangeData.Companies.Add(
            new()
            {
                Id = Guid.NewGuid(),
                Name = "value"
            });
        await ArrangeData.SaveChangesAsync();

        var entity = await ActData.Companies.SingleAsync();
        entity.Name = input;
        await ActData.SaveChangesAsync();

        return await AssertData.Companies.SingleAsync();
    }
}
```
<sup><a href='/src/EfLocalDb.NUnit.Tests/Tests.cs#L45-L70' title='Snippet source file'>snippet source</a> | <a href='#snippet-Combinations' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## VerifyEntity

Helpers for verifying entities by primary key, with optional Include/ThenInclude:

<!-- snippet: VerifyEntity -->
<a id='snippet-VerifyEntity'></a>
```cs
[Test]
public async Task VerifyEntity()
{
    var company = new Company
    {
        Id = Guid.NewGuid(),
        Name = "value"
    };
    ArrangeData.Companies.Add(company);
    await ArrangeData.SaveChangesAsync();
    await VerifyEntity<Company>(company.Id);
}
```
<sup><a href='/src/EfLocalDb.NUnit.Tests/Tests.cs#L131-L144' title='Snippet source file'>snippet source</a> | <a href='#snippet-VerifyEntity' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

<!-- snippet: VerifyEntityWithInclude -->
<a id='snippet-VerifyEntityWithInclude'></a>
```cs
[Test]
public async Task VerifyEntityWithInclude()
{
    var company = new Company
    {
        Id = Guid.NewGuid(),
        Name = "the Company"
    };
    var employee = new Employee
    {
        Id = Guid.NewGuid(),
        CompanyId = company.Id,
        Name = "the Employee"
    };
    ArrangeData.AddRange(company, employee);
    await ArrangeData.SaveChangesAsync();
    await VerifyEntity<Company>(company.Id)
        .Include(_ => _.Employees);
}
```
<sup><a href='/src/EfLocalDb.NUnit.Tests/Tests.cs#L150-L170' title='Snippet source file'>snippet source</a> | <a href='#snippet-VerifyEntityWithInclude' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

<!-- snippet: VerifyEntityWithThenInclude -->
<a id='snippet-VerifyEntityWithThenInclude'></a>
```cs
[Test]
public async Task VerifyEntityWithThenInclude()
{
    var company = new Company
    {
        Id = Guid.NewGuid(),
        Name = "the Company"
    };
    var employee = new Employee
    {
        Id = Guid.NewGuid(),
        CompanyId = company.Id,
        Name = "the Employee"
    };
    var vehicle = new Vehicle
    {
        Id = Guid.NewGuid(),
        EmployeeId = employee.Id,
        Model = "the Vehicle"
    };
    ArrangeData.AddRange(company, employee, vehicle);
    await ArrangeData.SaveChangesAsync();
    await VerifyEntity<Company>(company.Id)
        .Include(_ => _.Employees)
        .ThenInclude(_ => _.Vehicles);
}
```
<sup><a href='/src/EfLocalDb.NUnit.Tests/Tests.cs#L172-L199' title='Snippet source file'>snippet source</a> | <a href='#snippet-VerifyEntityWithThenInclude' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## VerifyEntities

Verify a collection of entities from a `DbSet` or `IQueryable`:

<!-- snippet: VerifyEntities_DbSet -->
<a id='snippet-VerifyEntities_DbSet'></a>
```cs
[Test]
public async Task VerifyEntities_DbSet()
{
    ArrangeData.Companies.Add(
        new()
        {
            Id = Guid.NewGuid(),
            Name = "value"
        });
    await ArrangeData.SaveChangesAsync();
    await VerifyEntities(AssertData.Companies);
}
```
<sup><a href='/src/EfLocalDb.NUnit.Tests/Tests.cs#L201-L214' title='Snippet source file'>snippet source</a> | <a href='#snippet-VerifyEntities_DbSet' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

<!-- snippet: VerifyEntity_Queryable -->
<a id='snippet-VerifyEntity_Queryable'></a>
```cs
[Test]
public async Task VerifyEntity_Queryable()
{
    var company = new Company
    {
        Id = Guid.NewGuid(),
        Name = "value"
    };
    ArrangeData.Companies.Add(company);
    await ArrangeData.SaveChangesAsync();
    await VerifyEntity(AssertData.Companies.Where(_ => _.Id == company.Id));
}
```
<sup><a href='/src/EfLocalDb.NUnit.Tests/Tests.cs#L229-L242' title='Snippet source file'>snippet source</a> | <a href='#snippet-VerifyEntity_Queryable' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## DbQuery

Mark test methods with `[DbQuery]` to share a single database across all query-only tests. Instead of cloning the template for each test, a shared database is created once and reused. This eliminates per-test DB creation overhead for tests that only read data.

Use `[DbQueryWithTransaction]` instead when tests need to write data. Each test runs inside an auto-rolling-back transaction, ensuring test isolation while still sharing the database instance.

Both attributes can be mixed in the same test fixture:

<!-- snippet: DbQueryTests -->
<a id='snippet-DbQueryTests'></a>
```cs
[TestFixture]
public class DbQueryTests :
    LocalDbTestBase<TheDbContext>
{
    [Test]
    [DbQuery]
    public async Task ReadFromSharedDb()
    {
        var count = await ActData.Companies.CountAsync();
        AreEqual(0, count);
    }

    [Test]
    [DbQueryWithTransaction]
    public async Task CanReadAndWrite()
    {
        ArrangeData.Companies.Add(
            new()
            {
                Id = Guid.NewGuid(),
                Name = "DbQueryWithTransaction Company"
            });
        await ArrangeData.SaveChangesAsync();

        var entity = await ActData.Companies.SingleAsync();
        AreEqual("DbQueryWithTransaction Company", entity.Name);
    }

    [Test]
    [DbQueryWithTransaction]
    public async Task DataIsRolledBack()
    {
        ArrangeData.Companies.Add(
            new()
            {
                Id = Guid.NewGuid(),
                Name = "Should Not Persist"
            });
        await ArrangeData.SaveChangesAsync();

        var count = await ActData.Companies.CountAsync();
        AreEqual(1, count);
    }

    [Test]
    [DbQueryWithTransaction]
    public async Task StartsWithEmptyDatabase()
    {
        var count = await ActData.Companies.CountAsync();
        AreEqual(0, count);
    }
}
```
<sup><a href='/src/EfLocalDb.NUnit.Tests/DbQueryTests.cs#L1-L54' title='Snippet source file'>snippet source</a> | <a href='#snippet-DbQueryTests' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## Parallel Execution

To run tests in parallel, configure parallelism at the assembly level:

<!-- snippet: EfLocalDb.NUnit.Tests/TestConfig.cs -->
<a id='snippet-EfLocalDb.NUnit.Tests/TestConfig.cs'></a>
```cs
[assembly: Parallelizable(ParallelScope.Fixtures)]
[assembly: LevelOfParallelism(2)]
```
<sup><a href='/src/EfLocalDb.NUnit.Tests/TestConfig.cs#L1-L2' title='Snippet source file'>snippet source</a> | <a href='#snippet-EfLocalDb.NUnit.Tests/TestConfig.cs' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->
