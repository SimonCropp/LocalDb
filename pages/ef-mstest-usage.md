<!--
GENERATED FILE - DO NOT EDIT
This file was generated by [MarkdownSnippets](https://github.com/SimonCropp/MarkdownSnippets).
Source File: /pages/mdsource/ef-mstest-usage.source.md
To change this file edit the source file and then run MarkdownSnippets.
-->

# EntityFramework Core MSTest Usage

Combines [EfLocalDb](/pages/ef-usage.md), [MSTest](https://learn.microsoft.com/en-us/dotnet/core/testing/unit-testing-mstest-intro), [Verify.MSTest](https://github.com/VerifyTests/Verify#verifymstest), and [Verify.EntityFramework](https://github.com/VerifyTests/Verify.EntityFramework) into a test base class that provides an isolated database per test with [Arrange-Act-Assert](https://learn.microsoft.com/en-us/visualstudio/test/unit-test-basics#write-your-tests) phase enforcement.


## EfLocalDb.MSTest package [![NuGet Status](https://img.shields.io/nuget/v/EfLocalDb.MSTest.svg)](https://www.nuget.org/packages/EfLocalDb.MSTest/)

https://nuget.org/packages/EfLocalDb.MSTest/


## Schema and data

The snippets use a DbContext of the following form:

<!-- snippet: EfLocalDb.MSTest.Tests/Model/TheDbContext.cs -->
<a id='snippet-EfLocalDb.MSTest.Tests/Model/TheDbContext.cs'></a>
```cs
public class TheDbContext(DbContextOptions options) : DbContext(options)
{
    public DbSet<Company> Companies { get; set; } = null!;
    public DbSet<Employee> Employees { get; set; } = null!;

    protected override void OnModelCreating(ModelBuilder builder)
    {
        var company = builder.Entity<Company>();
        company.HasKey(_ => _.Id);
        company.HasMany(_ => _.Employees).WithOne(_ => _.Company).IsRequired();

        var employee = builder.Entity<Employee>();
        employee.HasKey(_ => _.Id);
        employee.HasMany(_ => _.Vehicles).WithOne(_ => _.Employee).IsRequired();

        var vehicle = builder.Entity<Vehicle>();
        vehicle.HasKey(_ => _.Id);
    }
}
```
<sup><a href='/src/EfLocalDb.MSTest.Tests/Model/TheDbContext.cs#L1-L19' title='Snippet source file'>snippet source</a> | <a href='#snippet-EfLocalDb.MSTest.Tests/Model/TheDbContext.cs' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

<!-- snippet: EfLocalDb.MSTest.Tests/Model/Company.cs -->
<a id='snippet-EfLocalDb.MSTest.Tests/Model/Company.cs'></a>
```cs
public class Company
{
    public required Guid Id { get; init; }
    public required string Name { get; set; }
    public List<Employee> Employees { get; set; } = [];
}
```
<sup><a href='/src/EfLocalDb.MSTest.Tests/Model/Company.cs#L1-L6' title='Snippet source file'>snippet source</a> | <a href='#snippet-EfLocalDb.MSTest.Tests/Model/Company.cs' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

<!-- snippet: EfLocalDb.MSTest.Tests/Model/Employee.cs -->
<a id='snippet-EfLocalDb.MSTest.Tests/Model/Employee.cs'></a>
```cs
public class Employee
{
    public required Guid CompanyId { get; set; }
    public Company? Company { get; init; }
    public required Guid Id { get; init; }
    public required string Name { get; set; }
    public List<Vehicle> Vehicles { get; set; } = [];
}
```
<sup><a href='/src/EfLocalDb.MSTest.Tests/Model/Employee.cs#L1-L8' title='Snippet source file'>snippet source</a> | <a href='#snippet-EfLocalDb.MSTest.Tests/Model/Employee.cs' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## Initialize

`LocalDbTestBase<T>.Initialize` needs to be called once. This is best done in a [ModuleInitializer](https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/proposals/csharp-9.0/module-initializers):

<!-- snippet: EfLocalDb.MSTest.Tests/ModuleInitializer.cs -->
<a id='snippet-EfLocalDb.MSTest.Tests/ModuleInitializer.cs'></a>
```cs
public static class ModuleInitializer
{
    [ModuleInitializer]
    public static void Initialize()
    {
        VerifyDiffPlex.Initialize(OutputType.Compact);
        VerifierSettings.InitializePlugins();
        LocalDbLogging.EnableVerbose();
        LocalDbSettings.ConnectionBuilder(_ => _.ConnectTimeout = 300);
        LocalDbTestBase<TheDbContext>.Initialize();
    }
}
```
<sup><a href='/src/EfLocalDb.MSTest.Tests/ModuleInitializer.cs#L1-L12' title='Snippet source file'>snippet source</a> | <a href='#snippet-EfLocalDb.MSTest.Tests/ModuleInitializer.cs' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## Usage in a Test

Inherit from `LocalDbTestBase<T>` and use the `ArrangeData`, `ActData`, and `AssertData` properties. These enforce phase ordering: accessing `ActData` transitions from Arrange to Act, and accessing `AssertData` transitions to Assert. Accessing a phase out of order throws an exception.

<!-- snippet: EfLocalDb.MSTest.Tests/Tests.cs -->
<a id='snippet-EfLocalDb.MSTest.Tests/Tests.cs'></a>
```cs
[TestClass]
public class Tests :
    LocalDbTestBase<TheDbContext>
{
    [TestMethod]
    public async Task Simple()
    {
        ArrangeData.Companies.Add(
            new()
            {
                Id = Guid.NewGuid(),
                Name = "value"
            });
        await ArrangeData.SaveChangesAsync();

        var entity = await ActData.Companies.SingleAsync();
        entity.Name = "value2";
        await ActData.SaveChangesAsync();

        var result = await AssertData.Companies.SingleAsync();
        await Verify(result);
    }

    [TestMethod]
    public async Task StaticInstance()
    {
        Instance.ArrangeData.Companies.Add(
            new()
            {
                Id = Guid.NewGuid(),
                Name = "value"
            });
        await Instance.ArrangeData.SaveChangesAsync();

        var entity = await Instance.ActData.Companies.SingleAsync();
        entity.Name = "value2";
        await Instance.ActData.SaveChangesAsync();

        var result = await Instance.AssertData.Companies.SingleAsync();
        await Verify(result);
    }

    [TestMethod]
    public Task Combinations()
    {
        string[] inputs = ["value1", "value2"];
        return Combination()
            .Verify(Run, inputs);

        async Task<Company> Run(string input)
        {
            ArrangeData.Companies.Add(
                new()
                {
                    Id = Guid.NewGuid(),
                    Name = "value"
                });
            await ArrangeData.SaveChangesAsync();

            var entity = await ActData.Companies.SingleAsync();
            entity.Name = input;
            await ActData.SaveChangesAsync();

            return await AssertData.Companies.SingleAsync();
        }
    }

    [TestMethod]
    public Task Name() =>
        Verify(new
        {
            Database.Name,
            Database.Connection.DataSource
        });

    [TestMethod]
    public Task ThrowForRedundantIgnoreQueryFilters() =>
        ThrowsTask(
                () =>
                {
                    var entities = AssertData.Companies;
                    return entities.IgnoreQueryFilters().SingleAsync();
                })
            .IgnoreStackTrace();

    [TestMethod]
    public async Task IgnoreQueryFiltersAllowedOnArrangeAndAct()
    {
        await ArrangeData.Companies.IgnoreQueryFilters().ToListAsync();
        await ActData.Companies.IgnoreQueryFilters().ToListAsync();
    }

    [TestMethod]
    public async Task ActInAsync()
    {
        ArrangeData.Companies.Add(
            new()
            {
                Id = Guid.NewGuid(),
                Name = "value"
            });
        await ArrangeData.SaveChangesAsync();

        await AsyncMethod();

        var result = await AssertData.Companies.SingleAsync();
        await Verify(result);

        async Task AsyncMethod()
        {
            await Task.Delay(1);
            var entity = await ActData.Companies.SingleAsync();
            entity.Name = "value2";
            await ActData.SaveChangesAsync();
        }
    }

    [TestMethod]
    public async Task VerifyEntityById()
    {
        var company = new Company
        {
            Id = Guid.NewGuid(),
            Name = "value"
        };
        ArrangeData.Companies.Add(company);
        await ArrangeData.SaveChangesAsync();
        await VerifyEntity<Company>(company.Id);
    }

    [TestMethod]
    public async Task VerifyEntityByIdNull() =>
        await VerifyEntity<Company>(Guid.NewGuid());

    [TestMethod]
    public async Task VerifyEntityWithInclude()
    {
        var company = new Company
        {
            Id = Guid.NewGuid(),
            Name = "the Company"
        };
        var employee = new Employee
        {
            Id = Guid.NewGuid(),
            CompanyId = company.Id,
            Name = "the Employee"
        };
        ArrangeData.AddRange(company, employee);
        await ArrangeData.SaveChangesAsync();
        await VerifyEntity<Company>(company.Id)
            .Include(_ => _.Employees);
    }

    [TestMethod]
    public async Task VerifyEntityWithThenInclude()
    {
        var company = new Company
        {
            Id = Guid.NewGuid(),
            Name = "the Company"
        };
        var employee = new Employee
        {
            Id = Guid.NewGuid(),
            CompanyId = company.Id,
            Name = "the Employee"
        };
        var vehicle = new Vehicle
        {
            Id = Guid.NewGuid(),
            EmployeeId = employee.Id,
            Model = "the Vehicle"
        };
        ArrangeData.AddRange(company, employee, vehicle);
        await ArrangeData.SaveChangesAsync();
        await VerifyEntity<Company>(company.Id)
            .Include(_ => _.Employees)
            .ThenInclude(_ => _.Vehicles);
    }

    [TestMethod]
    public async Task VerifyEntities_DbSet()
    {
        ArrangeData.Companies.Add(
            new()
            {
                Id = Guid.NewGuid(),
                Name = "value"
            });
        await ArrangeData.SaveChangesAsync();
        await VerifyEntities(AssertData.Companies);
    }

    [TestMethod]
    public async Task VerifyEntities_Queryable()
    {
        var company = new Company
        {
            Id = Guid.NewGuid(),
            Name = "value"
        };
        ArrangeData.Companies.Add(company);
        await ArrangeData.SaveChangesAsync();
        await VerifyEntities(AssertData.Companies.Where(_ => _.Id == company.Id));
    }

    [TestMethod]
    public async Task VerifyEntity_Queryable()
    {
        var company = new Company
        {
            Id = Guid.NewGuid(),
            Name = "value"
        };
        ArrangeData.Companies.Add(company);
        await ArrangeData.SaveChangesAsync();
        await VerifyEntity(AssertData.Companies.Where(_ => _.Id == company.Id));
    }

    [TestMethod]
    public async Task ArrangeQueryableAfterAct()
    {
        var company = new Company
        {
            Id = Guid.NewGuid(),
            Name = "value"
        };
        ArrangeData.Companies.Add(company);
        await ArrangeData.SaveChangesAsync();
        var queryable = ArrangeData.Companies.Where(_ => _.Id == company.Id);
        // ReSharper disable once UnusedVariable
        var act = ActData;
        await ThrowsTask(() => VerifyEntities(queryable))
            .IgnoreStackTrace()
            .DisableRequireUniquePrefix();
    }

    [TestMethod]
    public Task AccessActAfterAssert()
    {
        // ReSharper disable once UnusedVariable
        var assert = AssertData;
        return Throws(() => ActData)
            .IgnoreStackTrace();
    }

    [TestMethod]
    public async Task ActQueryableAfterAssert()
    {
        var company = new Company
        {
            Id = Guid.NewGuid(),
            Name = "value"
        };
        ArrangeData.Companies.Add(company);
        await ArrangeData.SaveChangesAsync();
        var queryable = ActData.Companies.Where(_ => _.Id == company.Id);
        // ReSharper disable once UnusedVariable
        var assert = AssertData;
        await ThrowsTask(() => VerifyEntities(queryable))
            .IgnoreStackTrace()
            .DisableRequireUniquePrefix();
    }

    [TestMethod]
    public async Task ArrangeQueryableAfterAssert()
    {
        var company = new Company
        {
            Id = Guid.NewGuid(),
            Name = "value"
        };
        ArrangeData.Companies.Add(company);
        await ArrangeData.SaveChangesAsync();
        var queryable = ArrangeData.Companies.Where(_ => _.Id == company.Id);
        // ReSharper disable once UnusedVariable
        var assert = AssertData;
        await ThrowsTask(() => VerifyEntities(queryable))
            .IgnoreStackTrace()
            .DisableRequireUniquePrefix();
    }

    [TestMethod]
    public Task AccessArrangeAfterAssert()
    {
        // ReSharper disable once UnusedVariable
        var assert = AssertData;
        return Throws(() => ArrangeData)
            .IgnoreStackTrace();
    }

    [TestMethod]
    public Task AccessArrangeAfterAct()
    {
        // ReSharper disable once UnusedVariable
        var act = ActData;
        return Throws(() => ArrangeData)
            .IgnoreStackTrace();
    }
}
```
<sup><a href='/src/EfLocalDb.MSTest.Tests/Tests.cs#L1-L301' title='Snippet source file'>snippet source</a> | <a href='#snippet-EfLocalDb.MSTest.Tests/Tests.cs' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## Static Instance

The current test instance can be accessed via `LocalDbTestBase<T>.Instance`. This is useful when test helpers need to access the database outside the test class:

<!-- snippet: StaticInstanceMSTest -->
<a id='snippet-StaticInstanceMSTest'></a>
```cs
[TestMethod]
public async Task StaticInstance()
{
    Instance.ArrangeData.Companies.Add(
        new()
        {
            Id = Guid.NewGuid(),
            Name = "value"
        });
    await Instance.ArrangeData.SaveChangesAsync();

    var entity = await Instance.ActData.Companies.SingleAsync();
    entity.Name = "value2";
    await Instance.ActData.SaveChangesAsync();

    var result = await Instance.AssertData.Companies.SingleAsync();
    await Verify(result);
}
```
<sup><a href='/src/EfLocalDb.MSTest.Tests/Tests.cs#L24-L43' title='Snippet source file'>snippet source</a> | <a href='#snippet-StaticInstanceMSTest' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## Combinations

[Verify Combinations](https://github.com/VerifyTests/Verify#combinations) are supported. The database is reset for each combination:

<!-- snippet: CombinationsMSTest -->
<a id='snippet-CombinationsMSTest'></a>
```cs
[TestMethod]
public Task Combinations()
{
    string[] inputs = ["value1", "value2"];
    return Combination()
        .Verify(Run, inputs);

    async Task<Company> Run(string input)
    {
        ArrangeData.Companies.Add(
            new()
            {
                Id = Guid.NewGuid(),
                Name = "value"
            });
        await ArrangeData.SaveChangesAsync();

        var entity = await ActData.Companies.SingleAsync();
        entity.Name = input;
        await ActData.SaveChangesAsync();

        return await AssertData.Companies.SingleAsync();
    }
}
```
<sup><a href='/src/EfLocalDb.MSTest.Tests/Tests.cs#L45-L70' title='Snippet source file'>snippet source</a> | <a href='#snippet-CombinationsMSTest' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## VerifyEntity

Helpers for verifying entities by primary key, with optional Include/ThenInclude:

<!-- snippet: VerifyEntityMSTest -->
<a id='snippet-VerifyEntityMSTest'></a>
```cs
[TestMethod]
public async Task VerifyEntityById()
{
    var company = new Company
    {
        Id = Guid.NewGuid(),
        Name = "value"
    };
    ArrangeData.Companies.Add(company);
    await ArrangeData.SaveChangesAsync();
    await VerifyEntity<Company>(company.Id);
}
```
<sup><a href='/src/EfLocalDb.MSTest.Tests/Tests.cs#L122-L135' title='Snippet source file'>snippet source</a> | <a href='#snippet-VerifyEntityMSTest' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

<!-- snippet: VerifyEntityWithIncludeMSTest -->
<a id='snippet-VerifyEntityWithIncludeMSTest'></a>
```cs
[TestMethod]
public async Task VerifyEntityWithInclude()
{
    var company = new Company
    {
        Id = Guid.NewGuid(),
        Name = "the Company"
    };
    var employee = new Employee
    {
        Id = Guid.NewGuid(),
        CompanyId = company.Id,
        Name = "the Employee"
    };
    ArrangeData.AddRange(company, employee);
    await ArrangeData.SaveChangesAsync();
    await VerifyEntity<Company>(company.Id)
        .Include(_ => _.Employees);
}
```
<sup><a href='/src/EfLocalDb.MSTest.Tests/Tests.cs#L141-L161' title='Snippet source file'>snippet source</a> | <a href='#snippet-VerifyEntityWithIncludeMSTest' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

<!-- snippet: VerifyEntityWithThenIncludeMSTest -->
<a id='snippet-VerifyEntityWithThenIncludeMSTest'></a>
```cs
[TestMethod]
public async Task VerifyEntityWithThenInclude()
{
    var company = new Company
    {
        Id = Guid.NewGuid(),
        Name = "the Company"
    };
    var employee = new Employee
    {
        Id = Guid.NewGuid(),
        CompanyId = company.Id,
        Name = "the Employee"
    };
    var vehicle = new Vehicle
    {
        Id = Guid.NewGuid(),
        EmployeeId = employee.Id,
        Model = "the Vehicle"
    };
    ArrangeData.AddRange(company, employee, vehicle);
    await ArrangeData.SaveChangesAsync();
    await VerifyEntity<Company>(company.Id)
        .Include(_ => _.Employees)
        .ThenInclude(_ => _.Vehicles);
}
```
<sup><a href='/src/EfLocalDb.MSTest.Tests/Tests.cs#L163-L190' title='Snippet source file'>snippet source</a> | <a href='#snippet-VerifyEntityWithThenIncludeMSTest' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## VerifyEntities

Verify a collection of entities from a `DbSet` or `IQueryable`:

<!-- snippet: VerifyEntities_DbSetMSTest -->
<a id='snippet-VerifyEntities_DbSetMSTest'></a>
```cs
[TestMethod]
public async Task VerifyEntities_DbSet()
{
    ArrangeData.Companies.Add(
        new()
        {
            Id = Guid.NewGuid(),
            Name = "value"
        });
    await ArrangeData.SaveChangesAsync();
    await VerifyEntities(AssertData.Companies);
}
```
<sup><a href='/src/EfLocalDb.MSTest.Tests/Tests.cs#L192-L205' title='Snippet source file'>snippet source</a> | <a href='#snippet-VerifyEntities_DbSetMSTest' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

<!-- snippet: VerifyEntity_QueryableMSTest -->
<a id='snippet-VerifyEntity_QueryableMSTest'></a>
```cs
[TestMethod]
public async Task VerifyEntity_Queryable()
{
    var company = new Company
    {
        Id = Guid.NewGuid(),
        Name = "value"
    };
    ArrangeData.Companies.Add(company);
    await ArrangeData.SaveChangesAsync();
    await VerifyEntity(AssertData.Companies.Where(_ => _.Id == company.Id));
}
```
<sup><a href='/src/EfLocalDb.MSTest.Tests/Tests.cs#L220-L233' title='Snippet source file'>snippet source</a> | <a href='#snippet-VerifyEntity_QueryableMSTest' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## SharedDb

Mark test methods with `[SharedDb]` to share a single database across all query-only tests. Instead of cloning the template for each test, a shared database is created once and reused. This eliminates per-test DB creation overhead for tests that only read data.<!-- include: shared-db. path: /pages/mdsource/shared-db.include.md -->

Use `[SharedDbWithTransaction]` instead when tests need to write data. Each test runs inside an auto-rolling-back transaction, ensuring test isolation while still sharing the database instance.

Note: `[SharedDbWithTransaction]` means that on test failure the resulting database cannot be inspected (since the transaction is rolled back). A workaround when debugging a failure is to temporarily remove the attribute.

Both attributes can be mixed in the same test fixture:<!-- endInclude -->

<!-- snippet: SharedDbTestsMSTest -->
<a id='snippet-SharedDbTestsMSTest'></a>
```cs
[TestClass]
public class SharedDbTests : LocalDbTestBase<TheDbContext>
{
    [TestMethod]
    [SharedDb]
    public async Task ReadFromSharedDb()
    {
        var count = await ActData.Companies.CountAsync();
        Assert.AreEqual(0, count);
    }

    [TestMethod]
    [SharedDbWithTransaction]
    public async Task CanReadAndWrite()
    {
        ArrangeData.Companies.Add(
            new()
            {
                Id = Guid.NewGuid(),
                Name = "SharedDbWithTransaction Company"
            });
        await ArrangeData.SaveChangesAsync();

        var entity = await ActData.Companies.SingleAsync();
        Assert.AreEqual("SharedDbWithTransaction Company", entity.Name);
    }

    [TestMethod]
    [SharedDbWithTransaction]
    public async Task DataIsRolledBack()
    {
        ArrangeData.Companies.Add(
            new()
            {
                Id = Guid.NewGuid(),
                Name = "Should Not Persist"
            });
        await ArrangeData.SaveChangesAsync();

        var count = await ActData.Companies.CountAsync();
        Assert.AreEqual(1, count);
    }

    [TestMethod]
    [SharedDbWithTransaction]
    public async Task StartsWithEmptyDatabase()
    {
        var count = await ActData.Companies.CountAsync();
        Assert.AreEqual(0, count);
    }
}
```
<sup><a href='/src/EfLocalDb.MSTest.Tests/SharedDbTests.cs#L1-L53' title='Snippet source file'>snippet source</a> | <a href='#snippet-SharedDbTestsMSTest' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## Parallel Execution

To run tests in parallel, configure parallelism at the assembly level:

<!-- snippet: EfLocalDb.MSTest.Tests/TestConfig.cs -->
<a id='snippet-EfLocalDb.MSTest.Tests/TestConfig.cs'></a>
```cs
[assembly: Parallelize(Scope = ExecutionScope.ClassLevel, Workers = 2)]
```
<sup><a href='/src/EfLocalDb.MSTest.Tests/TestConfig.cs#L1-L1' title='Snippet source file'>snippet source</a> | <a href='#snippet-EfLocalDb.MSTest.Tests/TestConfig.cs' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->
