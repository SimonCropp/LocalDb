<!--
GENERATED FILE - DO NOT EDIT
This file was generated by [MarkdownSnippets](https://github.com/SimonCropp/MarkdownSnippets).
Source File: /pages/mdsource/row-versions-helper.source.md
To change this file edit the source file and then run MarkdownSnippets.
-->

# RowVersions

The `RowVersions` class provides utility methods for common SQL Server operations when working with LocalDb databases.

## Read

The `Read` method retrieves the current row version (timestamp) for all rows across all tables in a database that contain both an `Id` column (UNIQUEIDENTIFIER) and a `RowVersion` column (ROWVERSION).

### Usage

<!-- snippet: RowVersionsRead -->
<a id='snippet-RowVersionsRead'></a>
```cs
var sqlConnection = database.Connection;

var id1 = Guid.NewGuid();
var id2 = Guid.NewGuid();

await using (var command = sqlConnection.CreateCommand())
{
    command.CommandText = """
                          INSERT INTO MyTable (Id, Value) VALUES (@Id1, @Value1);
                          INSERT INTO MyTable (Id, Value) VALUES (@Id2, @Value2);
                          """;
    command.Parameters.AddWithValue("@Id1", id1);
    command.Parameters.AddWithValue("@Value1", "Test1");
    command.Parameters.AddWithValue("@Id2", id2);
    command.Parameters.AddWithValue("@Value2", "Test2");
    await command.ExecuteNonQueryAsync();
}

var result = await RowVersions.Read(sqlConnection);

AreEqual(2, result.Count);
True(result.ContainsKey(id1));
True(result.ContainsKey(id2));
IsTrue(result[id1] > 0);
IsTrue(result[id2] > 0);
AreNotEqual(result[id1], result[id2]);
```
<sup><a href='/src/LocalDb.Tests/RowVersionsTests.cs#L69-L98' title='Snippet source file'>snippet source</a> | <a href='#snippet-RowVersionsRead' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

### How It Works

The method:

1. Dynamically discovers all base tables in the database that have both:
   - An `Id` column of type UNIQUEIDENTIFIER
   - A `RowVersion` column of type ROWVERSION

2. Constructs a dynamic SQL query using `STRING_AGG` to union all matching tables

3. Returns a dictionary mapping entity IDs (Guid) to their row versions (ulong)

### Row Version Behavior

SQL Server's `ROWVERSION` (also known as `TIMESTAMP`) is a monotonically increasing value that:
- Automatically changes every time a row is modified
- Is unique within the database
- Can be used to detect if data has changed since it was last read

The method converts the 8-byte ROWVERSION value to a `ulong` for easier comparison in C# code.


### When to Use

Use cases:

- Track which entities have been modified
- Implement optimistic concurrency control
- Detect stale data in caching scenarios
- Synchronize data between systems


### Requirements

Tables must have:

- A column named `Id` of type `UNIQUEIDENTIFIER`
- A column named `RowVersion` of type `ROWVERSION`

Tables without either of these columns will be ignored by the query.
