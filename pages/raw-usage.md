<!--
GENERATED FILE - DO NOT EDIT
This file was generated by [MarkdownSnippets](https://github.com/SimonCropp/MarkdownSnippets).
Source File: /pages/mdsource/raw-usage.source.md
To change this file edit the source file and then run MarkdownSnippets.
-->

# Raw SQL Usage

Interactions with SqlLocalDB via a [SqlConnection](https://docs.microsoft.com/en-us/dotnet/api/system.data.sqlclient.sqlconnection).


## LocalDb package [![NuGet Status](https://img.shields.io/nuget/v/LocalDb.svg)](https://www.nuget.org/packages/LocalDb/)

https://nuget.org/packages/LocalDb/


## Schema and data

The snippets use the following helper class:

<!-- snippet: TestDbBuilder.cs -->
<a id='snippet-TestDbBuilder.cs'></a>
```cs
public static class TestDbBuilder
{
    public static async Task CreateTable(SqlConnection connection)
    {
        await using var command = connection.CreateCommand();
        command.CommandText = "create table MyTable (Value int);";
        await command.ExecuteNonQueryAsync();
    }

    static int intData;

    public static async Task<int> AddData(SqlConnection connection)
    {
        await using var command = connection.CreateCommand();
        var addData = intData;
        intData++;
        command.CommandText = $"""
            insert into MyTable (Value)
            values ({addData});
            """;
        await command.ExecuteNonQueryAsync();
        return addData;
    }

    public static async Task<List<int>> GetData(SqlConnection connection)
    {
        var values = new List<int>();
        await using var command = connection.CreateCommand();
        command.CommandText = "select Value from MyTable";
        await using var reader = await command.ExecuteReaderAsync();
        while (await reader.ReadAsync())
        {
            values.Add(reader.GetInt32(0));
        }

        return values;
    }
}
```
<sup><a href='/src/LocalDb.Tests/TestDbBuilder.cs#L1-L38' title='Snippet source file'>snippet source</a> | <a href='#snippet-TestDbBuilder.cs' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## Initialize SqlInstance

SqlInstance needs to be initialized once.

To ensure this happens only once there are several approaches that can be used:


### Static constructor

In the static constructor of a test.

If all tests that need to use the SqlInstance existing in the same test class, then the SqlInstance can be initialized in the static constructor of that test class.

<!-- snippet: StaticConstructor -->
<a id='snippet-StaticConstructor'></a>
```cs
[TestFixture]
public class Tests
{
    static SqlInstance sqlInstance = new(
        name: "StaticConstructorInstance",
        buildTemplate: TestDbBuilder.CreateTable);

    [Test]
    public async Task Test()
    {
        await using var database = await sqlInstance.Build();
        await TestDbBuilder.AddData(database);
        var data = await TestDbBuilder.GetData(database);
        AreEqual(1, data.Count);
    }
```
<sup><a href='/src/LocalDb.Tests/Snippets/StaticConstructor.cs#L3-L21' title='Snippet source file'>snippet source</a> | <a href='#snippet-StaticConstructor' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


### Static constructor in test base

If multiple tests need to use the SqlInstance, then the SqlInstance should be initialized in the static constructor of test base class.

<!-- snippet: TestBase -->
<a id='snippet-TestBase'></a>
```cs
[TestFixture]
public abstract class TestBase
{
    static SqlInstance instance;

    static TestBase() =>
        instance = new(
            name: "TestBaseUsage",
            buildTemplate: TestDbBuilder.CreateTable);

    public static Task<SqlDatabase> LocalDb(
        [CallerFilePath] string testFile = "",
        string? databaseSuffix = null,
        [CallerMemberName] string memberName = "") =>
        instance.Build(testFile, databaseSuffix, memberName);
}

public class Tests :
    TestBase
{
    [Test]
    public async Task Test()
    {
        await using var database = await LocalDb();
        await TestDbBuilder.AddData(database);
        var data = await TestDbBuilder.GetData(database);
        AreEqual(1, data.Count);
    }
}
```
<sup><a href='/src/LocalDb.Tests/Snippets/TestBaseUsage.cs#L3-L35' title='Snippet source file'>snippet source</a> | <a href='#snippet-TestBase' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## Usage in a Test

Usage inside a test consists of two parts:


### Build a SqlDatabase

<!-- snippet: BuildDatabase -->
<a id='snippet-BuildDatabase'></a>
```cs
await using var database = await sqlInstance.Build();

await TestDbBuilder.AddData(database);
var data = await TestDbBuilder.GetData(database);
AreEqual(1, data.Count);
```
<sup><a href='/src/LocalDb.Tests/Snippets/SnippetTests.cs#L14-L26' title='Snippet source file'>snippet source</a> | <a href='#snippet-BuildDatabase' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

See: [Database Name Resolution](/pages/directory-and-name-resolution.md#database-name-resolution)


### Using SQLConnection

<!-- snippet: BuildContext -->
<a id='snippet-BuildContext'></a>
```cs
await TestDbBuilder.AddData(database);
var data = await TestDbBuilder.GetData(database);
AreEqual(1, data.Count);
```
<sup><a href='/src/LocalDb.Tests/Snippets/SnippetTests.cs#L18-L24' title='Snippet source file'>snippet source</a> | <a href='#snippet-BuildContext' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


### Full Test

The above are combined in a full test:

<!-- snippet: SnippetTests -->
<a id='snippet-SnippetTests'></a>
```cs
[TestFixture]
public class SnippetTests
{
    static SqlInstance sqlInstance = new(
        name: "Snippets",
        buildTemplate: TestDbBuilder.CreateTable);

    [Test]
    public async Task TheTest()
    {

        await using var database = await sqlInstance.Build();

        await TestDbBuilder.AddData(database);
        var data = await TestDbBuilder.GetData(database);
        AreEqual(1, data.Count);

    }

    [Test]
    public async Task TheTestWithDbName()
    {

        await using var database = await sqlInstance.Build("TheTestWithDbName");

        await TestDbBuilder.AddData(database);
        var data = await TestDbBuilder.GetData(database);
        AreEqual(1, data.Count);
    }
```
<sup><a href='/src/LocalDb.Tests/Snippets/SnippetTests.cs#L1-L45' title='Snippet source file'>snippet source</a> | <a href='#snippet-SnippetTests' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## Shared Database

`BuildShared` creates a single database from the template once and reuses it across calls. This is useful for query-only tests that don't need per-test isolation.

<!-- snippet: SharedDatabase -->
<a id='snippet-SharedDatabase'></a>
```cs
[Test]
public async Task SharedDatabase()
{
    using var instance = new SqlInstance(
        "SharedDatabase",
        TestDbBuilder.CreateTable);

    await using var database = await instance.BuildShared();
    var data = await TestDbBuilder.GetData(database);
    AreEqual(0, data.Count);
}
```
<sup><a href='/src/LocalDb.Tests/Tests.cs#L148-L162' title='Snippet source file'>snippet source</a> | <a href='#snippet-SharedDatabase' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

Pass `useTransaction: true` to get an auto-rolling-back transaction, allowing writes without affecting other tests.

Note: `useTransaction: true` means that on test failure the resulting database cannot be inspected (since the transaction is rolled back). A workaround when debugging a failure is to temporarily remove `useTransaction: true`.

<!-- snippet: SharedDatabase_WithTransaction -->
<a id='snippet-SharedDatabase_WithTransaction'></a>
```cs
[Test]
public async Task SharedDatabase_WithTransaction()
{
    using var instance = new SqlInstance(
        "SharedDb_Tran",
        TestDbBuilder.CreateTable);

    await using (var database =
        await instance.BuildShared(useTransaction: true))
    {
        NotNull(database.Transaction);
        await using var command =
            database.Connection.CreateCommand();
        command.Transaction = database.Transaction;
        command.CommandText =
            "insert into MyTable (Value) values (42);";
        await command.ExecuteNonQueryAsync();
    }

    // Data should be rolled back
    await using var database2 =
        await instance.BuildShared();
    var data = await TestDbBuilder.GetData(database2);
    AreEqual(0, data.Count);
}
```
<sup><a href='/src/LocalDb.Tests/Tests.cs#L180-L208' title='Snippet source file'>snippet source</a> | <a href='#snippet-SharedDatabase_WithTransaction' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->
